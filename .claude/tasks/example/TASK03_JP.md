# TASK テンプレート — 機能開発指示書

> **用途**: 機能（または機能の一部）ごとにこのファイルをコピーし、`TASKXX_<機能名>.md` として保存する  
> **参照者**: 開発者・テスタ（チームメイトがこのファイルを読んで作業する）  
> **注意**: このファイルは「何を作るか」の仕様書です。「誰がどう進めるか」は TEAMCREATE.md に記載します。

---

## 1. 基本情報

| 項目 | 内容 |
|---|---|
| タスクID | TASK03 |
| 機能名 | アサイン |
| 関連 TEAMCREATE | TEAMCREATE_ASSIGNMENT.md |
| 対象画面 / URL | assignment |
| 優先度 | 高 |

---

## 2. 機能概要

### アサイン編集グリッド
- ユーザは、案件別、WBSの各タスク別かつ、工数別に、担当を追加して、大日程の期間中に、月単位で数値を入力できるものとする。
- 案件別に切り替えることができるものとする。
- GUIはWBS編集画面によく似た（ほぼ同じような）画面で、TreeGridとなる。
- WBS編集画面は、案件がTree構成で細分化されて、末端のタスクが入力できるようになっているが、本画面は、その下位層に、メンバという層が追加できるようなIFとなる。
- 行方向にはタスクや、メンバがTreeで表示され、列方向には、大日程で設定された最小開始日の月から最大の終了日の月までが月単位で列が作られる。
- メンバは担当者設定で設定されている名前がセレクトボックスで入力できるものとする。
- 行追加時は、未選択で行は空となっているが、フォーカスアウトなど行情報確定時は必ず選択させる。未選択のときは確定させず、バリデーションをかけ、ユーザに入力を促す。
- 大日程が編集されて拡張変更された場合は、大日程に合わせて列の構造も変更になる。
- 大日程が編集されて縮小変更された場合も、大日程に合わせて列の構造も変更になるが、設定していたデータは保持し続ける。
- 案件別、タスク別、メンバー別、かつ月別に設定された数値は、永続保持される。
- 月別、メンバー別に集計した値が、1.0よりオーバーする場合は、オーバーしている旨をトーストで表示し、バリデーションをかける

### メンバー別、月別、案件合計アサイングリッド
- TreeGridの編集領域の上部に、行方向にメンバー名、列方向に編集領域と同様の列情報（月）を配置した、メンバー別、月別集計表をフォントサイズを少し小さめに作成する。
- 単月あたりのメンバーの案件別のアサイン情報を表示できるものとするため、アサイン別に集計した値を表示するものとする。（例えばAさんが4月にX案件に0.4、Y案件に0.3、Z案件に0.2だとすると、Aさんとしては合計0.9アサンされていることがわかること。また、ホバーで内訳として、各案件別のアサイン状況が表示されること）
- このグリッドは、編集領域を邪魔しないように、アコーディオンで表示領域を潰し込めること。

---

## 3. 対象ファイル・ディレクトリ

| 種別 | パス | 備考 |
|---|---|---|
| ページ | src/features/assignment/pages/AssignmentPage.tsx | Next.js |
| コンポーネント | src/features/assignment/components/XXXDialogs.tsx, XXXTree.tsx, XXXTreeGrid.tsxなど状況に応じて作成 | 新規作成 |
| ユニットテスト | src/test/assignment.test.ts(状況に応じて) | 開発者が作成 |
| E2E テスト | e2e/assignment.spec.ts | テスタが作成 |

> **重要**: 上記以外の「既存」ファイルは勝手に変更しないこと。

---

## 4. 機能要件

### 4.1 画面仕様

- アサイン編集領域、既存WBS編集画面のTreeGrid構成
- メンバー設定はセレクトボックスで、選択情報は、担当者管理で設定されているメンバー名
- アサイン数は最小単位は小数点第2位でゼロパディングして桁合わせ、半角数字のみの入力、全角入力時は、自動半角補正
- 画面枠の横方向の固定はメンバまでは固定
- 画面枠の縦方向の固定はヘッダ固定
- 入力確定時に、永続保持するために保存される

## 5. 非機能要件

| 項目 | 要件 |
|---|---|
| アクセシビリティ | フォームに適切な label / aria 属性を付与。キーボード操作で完結すること |
| レスポンシブ | モバイル（375px〜）/ タブレット / デスクトップに対応 |
| パフォーマンス | 不要な再レンダリングを避ける。送信中の二重クリック防止 |

---

## 6. ユニットテスト方針（開発者向け）

開発者は実装と同時に以下のユニットテストを作成すること。

| テスト観点 | 内容 |
|---|---|
| レンダリング | フォームの各要素が正しく表示されること |
| バリデーション | 空入力 / 不正形式でエラーメッセージが表示されること |
| 送信 | 正しい入力で API が呼ばれること |
| ローディング | 送信中にボタンが disabled になること |
| エラー表示 | ユーザにわかりやすいエラーメッセージが表示されること |

使用ライブラリ: React Testing Library + vitest

---

## 7. E2E テスト方針（テスタ向け）

テスタは機能要件を把握し、最低限の機能への Playwright E2E テストを作成すること。


### 基本操作

| # | シナリオ | 期待結果 |
|---|---|---|
| 1 | 案件を切り替える | 選択した案件に紐づくWBS（タスクツリー）とメンバー行が表示され、既存の入力値が正しく反映される |
| 2 | TreeGridでタスクの親子階層を展開・折りたたむ | 子タスクおよびその配下のメンバー行が展開・折りたたみされ、表示が正しく切り替わる |
| 3 | 末端タスクの配下にメンバー行を追加する | 空行が追加され、メンバー名が未選択状態、月別セルが空の状態で表示される |
| 4 | 追加したメンバー行のセレクトボックスで担当者を選択する | 担当者設定に登録されているメンバー名がセレクトボックスの選択肢として表示され、選択・確定できる |
| 5 | 案件別、タスク別、メンバー別、月別のセルに数値（例：0.5）を入力する | 入力した数値がセルに反映され、保存される |
| 6 | 複数のタスクに同一メンバーを割り当て、それぞれ異なる月に数値を入力する | 各タスク・月ごとに独立して数値が保持される |

### 列構造（大日程連動）

| # | シナリオ | 期待結果 |
|---|---|---|
| 7 | 大日程の終了日を後ろに延長する（例：12月→翌3月） | 延長分の月列が右側に追加され、既存の入力値はそのまま保持される |
| 8 | 大日程の開始日を前倒しする（例：4月→1月） | 前倒し分の月列が左側に追加され、既存の入力値はそのまま保持される |
| 9 | 大日程の終了日を縮小する（例：翌3月→12月） | 縮小後の範囲外の月列は非表示となるが、設定済みデータは内部的に保持される |
| 10 | 大日程の開始日を後ろに縮小する（例：1月→4月） | 縮小後の範囲外の月列は非表示となるが、設定済みデータは内部的に保持される |
| 11 | 大日程を縮小後、再度拡張して元の範囲に戻す | 縮小時に非表示だった月列が再表示され、以前入力していた数値がそのまま復元される |

### バリデーション（メンバー未選択）

| # | シナリオ | 期待結果 |
|---|---|---|
| 12 | メンバー行を追加し、メンバー名を未選択のままフォーカスアウトする | バリデーションエラーが表示され、メンバー名の入力を促すメッセージが表示される。行の確定は行われない |
| 13 | メンバー行を追加し、メンバー名を未選択のまま数値を入力しようとする | メンバー名が未選択であることを警告し、先にメンバーの選択を求める |
| 14 | バリデーションエラー表示後、メンバーを選択して確定する | エラーが解消され、行が正常に確定し、月別セルへの入力が可能になる |

### バリデーション（アサイン超過）

| # | シナリオ | 期待結果 |
|---|---|---|
| 15 | メンバーAの4月のアサインが案件合計で1.0を超える値を入力する（例：案件Xに0.6、案件Yに0.5） | トーストで「メンバーAの4月のアサインが1.0を超過しています」旨のメッセージが表示される |
| 16 | アサイン超過の状態から、数値を修正して合計1.0以下にする | 超過警告のトーストが消え、正常状態となる |
| 17 | 複数メンバーが同時に異なる月でそれぞれ1.0を超過する | 超過しているメンバー・月ごとにそれぞれトーストで警告が表示される |

### データ永続化

| # | シナリオ | 期待結果 |
|---|---|---|
| 18 | 数値を入力後、別の案件に切り替えてから元の案件に戻る | 入力した数値がすべて保持されている |
| 19 | 数値を入力後、画面をリロードする | 入力済みの案件別・タスク別・メンバー別・月別の数値がすべて復元される |
| 20 | メンバー行を追加・数値入力後、別画面に遷移してから戻る | 追加したメンバー行と入力値がすべて保持されている |

### メンバー別・月別・案件合計アサイングリッド（上部集計表）

| # | シナリオ | 期待結果 |
|---|---|---|
| 21 | 集計表を表示する | 行方向にメンバー名、列方向に大日程の月が表示され、各セルにメンバーの案件合計アサイン値が表示される |
| 22 | 編集領域でメンバーAの4月に0.4を入力する（他案件合計が0.3の場合） | 集計表のメンバーAの4月セルが即座に0.7に更新される |
| 23 | 集計表のセルにマウスホバーする（例：メンバーAの4月、合計0.9） | ツールチップで案件別内訳が表示される（例：X案件：0.4、Y案件：0.3、Z案件：0.2） |
| 24 | 集計表のセルで合計が1.0を超過している場合にホバーする | 内訳表示に加え、超過していることが視覚的にわかる表示（赤字等）がされる |
| 25 | アコーディオンの折りたたみボタンをクリックする | 集計表が折りたたまれ、編集領域が広がる |
| 26 | アコーディオンの展開ボタンをクリックする | 集計表が再表示され、最新の集計値が反映されている |
| 27 | 集計表を折りたたんだ状態で編集領域の数値を変更し、集計表を再展開する | 変更後の集計値が正しく反映されている |

### 複合シナリオ

| # | シナリオ | 期待結果 |
|---|---|---|
| 28 | 案件X・Y・ZにメンバーAをそれぞれ割り当て、同月に数値を入力後、集計表で確認する | 集計表のメンバーAの該当月に全案件合計値が表示され、ホバーで案件別内訳が確認できる |
| 29 | 大日程を拡張後、新たに追加された月にアサインを入力し、集計表を確認する | 新規月列が集計表にも追加され、入力値が正しく集計される |
| 30 | 大日程を縮小後、再拡張して復元されたデータが集計表にも反映されることを確認する | 復元されたデータが集計表の合計値・ホバー内訳に正しく反映される |

使用ライブラリ: Playwright

## 8. 備考

関連するすべての機能とインタラクションを含めてください。基本を超えて、完全に機能する実装を作成してください。
